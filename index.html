<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Penguin 3D Viewer</title>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <!-- GLTF Loader (non-module) -->
  <script src="https://unpkg.com/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>
  <!-- Orbit Controls (non-module) -->
  <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #222;
      font-family: sans-serif;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      background: rgba(0, 0, 0, 0.6);
      padding: 6px 10px;
      border-radius: 6px;
      z-index: 2;
    }
    #log {
      position: absolute;
      bottom: 10px;
      left: 10px;
      color: white;
      background: rgba(0,0,0,0.6);
      padding: 6px 10px;
      border-radius: 6px;
      max-width: 50%;
      font-size: 12px;
      z-index: 2;
      white-space: pre-wrap;
    }
    canvas { display: block; }
  </style>
</head>
<body>
  <div id="info">üêß Move mouse to rotate ‚Ä¢ Scroll to zoom 2000</div>
  <div id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    function log(...args) {
      console.log(...args);
      logEl.textContent = args.join(' ') + '\n' + logEl.textContent;
    }

    if (location.protocol === 'file:') {
      log('‚ö†Ô∏è You are opening this page with the file:// protocol. GLTF files are often blocked by the browser when loaded from file://. Serve this folder with a local HTTP server (see instructions below).');
    }

    // Basic scene + renderer
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x333333);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.01, 1000);
    camera.position.set(0, 1.5, 3);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;
    document.body.appendChild(renderer.domElement);

    // Lights
    const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 1.5);
    dir.position.set(5, 10, 5);
    scene.add(dir);

    const ambient = new THREE.AmbientLight(0xffffff, 0.3);
    scene.add(ambient);

    // Helpers (helps confirm camera / scale)
    const grid = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
    grid.position.y = -1.0;
    scene.add(grid);

    const axes = new THREE.AxesHelper(1.5);
    scene.add(axes);

    // Controls
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.target.set(0, 0, 0);

    // Loading manager for better logging
    const manager = new THREE.LoadingManager();
    manager.onStart = () => log('Loading started...');
    manager.onLoad = () => log('All resources loaded.');
    manager.onProgress = (url, itemsLoaded, itemsTotal) => log(`Loaded ${itemsLoaded}/${itemsTotal}: ${url}`);
    manager.onError = (url) => log('Error loading:', url);

    const loader = new THREE.GLTFLoader(manager);

    // Name must match exact file name (case-sensitive on many servers)
    const glbPath = './penguin.glb';

    loader.load(
      glbPath,
      (gltf) => {
        log('Model loaded:', glbPath);

        const model = gltf.scene || gltf.scenes[0];
        if (!model) {
          log('No scene in GLTF.');
          return;
        }

        // Add model temporarily to compute size & center
        scene.add(model);

        // Compute bounding box and center the model
        const box = new THREE.Box3().setFromObject(model);
        if (!box.isEmpty()) {
          const size = box.getSize(new THREE.Vector3());
          const center = box.getCenter(new THREE.Vector3());

          // Move model so center is at (0,0,0)
          model.position.x += (model.position.x - center.x);
          model.position.y += (model.position.y - center.y);
          model.position.z += (model.position.z - center.z);

          // Fit camera to model
          const maxDim = Math.max(size.x, size.y, size.z);
          const fov = camera.fov * (Math.PI / 180);
          let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
          cameraZ *= 1.5; // some padding
          camera.position.set(center.x, center.y + maxDim * 0.2, center.z + cameraZ);
          controls.target.copy(center);

          log('Model size:', size.x.toFixed(2), size.y.toFixed(2), size.z.toFixed(2));
        } else {
          log('Warning: bounding box is empty; model may be invisible or not yet computed.');
        }

        // Don't forcibly replace materials ‚Äî preserve original materials when possible.
        // But if a mesh has no material, give it a basic standard material so it's visible.
        model.traverse((child) => {
          if (child.isMesh) {
            if (!child.material) {
              child.material = new THREE.MeshStandardMaterial({ color: 0xdddddd });
              child.material.side = THREE.DoubleSide;
            } else {
              // Ensure standard lights affect it: convert if it's a non-standard material (optional)
              // Keep the original material to respect textures/UVs.
            }
            child.castShadow = true;
            child.receiveShadow = true;
          }
        });

        // Start animation loop
        function animate() {
          requestAnimationFrame(animate);
          model.rotation.y += 0.003; // slow spin
          controls.update();
          renderer.render(scene, camera);
        }
        animate();
      },
      (xhr) => {
        const pct = (xhr.loaded / xhr.total * 100).toFixed(1);
        log(`GLTFLoader progress: ${pct}%`);
      },
      (err) => {
        log('üö® Error loading model:', err && err.message ? err.message : err);
        console.error(err);
      }
    );

    // Resize handling
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Quick troubleshooting hint overlay (click to copy)
    log('If you see a blank screen:');
    log('- Make sure penguin.glb is in the same folder and the name is EXACT (case-sensitive).');
    log('- Don‚Äôt open index.html with file:// in Chrome/Firefox: start a local server (examples below).');
    log('- Check the browser console (F12) for network / CORS / parse errors.');

  </script>
</body>
</html>

